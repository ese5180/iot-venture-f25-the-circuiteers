#!/bin/bash
#
# Pre-commit hook for Mock Unit Tests
# 
# Runs mock unit tests before allowing commits
# Ensures no breaking changes are committed
#

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get the directory where this hook is located
HOOK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$HOOK_DIR/../.." && pwd)"
TEST_DIR="$REPO_ROOT/sensors_test/tests_unit_mock"

echo -e "${YELLOW} Running Mock Unit Tests (Pre-commit Hook)${NC}"
echo "================================================"

# Check if tests_unit_mock exists
if [ ! -d "$TEST_DIR" ]; then
    echo -e "${YELLOW}  Mock tests directory not found at: $TEST_DIR${NC}"
    echo "Skipping pre-commit tests (tests_unit_mock not configured)"
    exit 0
fi

# Build tests if not already built
if [ ! -d "$TEST_DIR/build" ]; then
    echo "Building mock tests..."
    mkdir -p "$TEST_DIR/build"
    cd "$TEST_DIR/build"
    cmake -DCMAKE_BUILD_TYPE=Release .. > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo -e "${RED} CMake configuration failed${NC}"
        exit 1
    fi
    cmake --build . > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo -e "${RED} Build failed${NC}"
        exit 1
    fi
fi

# Run tests
cd "$TEST_DIR/build"
ctest --output-on-failure 2>&1 | tee /tmp/test_output.log

# Check test results
if [ ${PIPESTATUS[0]} -eq 0 ]; then
    echo ""
    echo -e "${GREEN} All mock unit tests PASSED!${NC}"
    echo "================================================"
    exit 0
else
    echo ""
    echo -e "${RED} Mock unit tests FAILED!${NC}"
    echo "================================================"
    echo "Fix the failing tests before committing."
    echo ""
    echo "To run tests manually:"
    echo "  cd $TEST_DIR/build"
    echo "  ctest --output-on-failure"
    echo ""
    exit 1
fi
