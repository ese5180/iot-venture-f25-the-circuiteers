#!/bin/bash
#
# Pre-push hook for VendGuard project
# Performs build verification before allowing a push
#

set -e

echo "ðŸ”¨ Running pre-push build verification..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}Error: Not in a git repository${NC}"
    exit 1
fi

# Check if Zephyr environment is available
if [ -z "$ZEPHYR_BASE" ]; then
    echo -e "${YELLOW}âš  Warning: ZEPHYR_BASE not set. Skipping build verification.${NC}"
    echo "To enable build checks, source zephyr/zephyr-env.sh first"
    exit 0
fi

# Check if west is available
if ! command -v west &> /dev/null; then
    echo -e "${YELLOW}âš  Warning: west not found. Skipping build verification.${NC}"
    exit 0
fi

# Get the main application directory
MAIN_APP="apps"
BOARD="nucleo_wl55jc"

if [ ! -d "$MAIN_APP" ]; then
    echo -e "${YELLOW}âš  Warning: $MAIN_APP directory not found. Skipping build.${NC}"
    exit 0
fi

echo "Building $MAIN_APP for $BOARD..."

# Try to build (with timeout to prevent hanging)
if timeout 300 west build -p always -b "$BOARD" "$MAIN_APP" > /tmp/build.log 2>&1; then
    if [ -f "build/zephyr/zephyr.elf" ]; then
        echo -e "${GREEN}âœ“ Build verification passed${NC}"
        exit 0
    else
        echo -e "${RED}âœ— Build completed but zephyr.elf not found${NC}"
        exit 1
    fi
else
    BUILD_EXIT_CODE=$?
    if [ $BUILD_EXIT_CODE -eq 124 ]; then
        echo -e "${RED}âœ— Build timed out after 5 minutes${NC}"
    else
        echo -e "${RED}âœ— Build failed${NC}"
        echo "Last 20 lines of build log:"
        tail -n 20 /tmp/build.log || true
    fi
    exit 1
fi

